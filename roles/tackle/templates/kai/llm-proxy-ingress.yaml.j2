---
# TODO: This ingress creates an external endpoint for the LLM proxy
# The actual external URL should be extracted and made available as llm_proxy_external_url
# so it can be shared with users who need to connect to the proxy
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
{% if llm_proxy_ingress_class_name | default(ui_ingress_class_name) == 'nginx' %}
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: {{ llm_proxy_ingress_proxy_body_size | default('100m') }}
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
{% elif llm_proxy_ingress_class_name | default(ui_ingress_class_name) == 'alb' %}
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/scheme: internet-facing
{% endif %}
  name: llm-proxy
  namespace: {{ app_namespace }}
  labels:
    app.kubernetes.io/name: llm-proxy
    app.kubernetes.io/component: ingress
    app.kubernetes.io/part-of: {{ app_name }}
    app: {{ app_name }}
spec:
  ingressClassName: {{ llm_proxy_ingress_class_name | default(ui_ingress_class_name) }}
  tls:
    - {}
  rules:
    - host: {{ llm_proxy_host | default('llm-proxy.' ~ (ingress_base_domain | default('local'))) }}
      http:
        paths:
          - path: /
{% if llm_proxy_ingress_path_type is defined %}
            pathType: {{ llm_proxy_ingress_path_type }}
{% elif llm_proxy_ingress_class_name | default(ui_ingress_class_name) == 'alb' %}
            pathType: Prefix
{% else %}
            pathType: ImplementationSpecific
{% endif %}
            backend:
              service:
                name: llm-proxy
                port:
                  number: 8321
