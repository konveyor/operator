name: LLM Proxy Integration Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  llm-proxy-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'

    - name: Start minikube
      uses: konveyor/tackle2-operator/.github/actions/start-minikube@main

    - name: Build operator images
      run: |
        eval $(minikube docker-env)
        IMG=ttl.sh/konveyor-tackle-operator-${{ github.run_id }}:2h make docker-build docker-push
        BUNDLE_IMG=ttl.sh/konveyor-tackle-operator-bundle-${{ github.run_id }}:2h make bundle bundle-build bundle-push

    - name: Install operator-sdk
      run: |
        curl -LO https://github.com/operator-framework/operator-sdk/releases/download/v1.35.0/operator-sdk_linux_amd64
        chmod +x operator-sdk_linux_amd64
        sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk

    - name: Install OLM
      run: |
        # Check if OLM is already installed
        if kubectl get crd clusterserviceversions.operators.coreos.com &>/dev/null; then
          echo "OLM already installed, checking status..."
          kubectl get csv -A
        else
          echo "Installing OLM..."
          operator-sdk olm install --version 0.28.0
        fi
        # Wait for packageserver deployment instead of CSV
        kubectl wait --for=condition=available deployment/packageserver -n olm --timeout=300s || true

    - name: Deploy operator
      run: |
        kubectl create namespace konveyor-tackle || true
        operator-sdk run bundle ttl.sh/konveyor-tackle-operator-bundle-${{ github.run_id }}:2h \
          --namespace konveyor-tackle \
          --timeout 15m
        kubectl wait --for=condition=available deployment/tackle-operator \
          -n konveyor-tackle \
          --timeout=600s

    - name: Run LLM proxy integration tests
      run: ./test/e2e/llm-proxy/run-test.sh

    - name: Debug on failure
      if: failure()
      run: |
        echo "=== Pod Status ==="
        kubectl get pods -n konveyor-tackle
        echo ""
        echo "=== Recent Events ==="
        kubectl get events -n konveyor-tackle --sort-by='.lastTimestamp' | tail -20
        echo ""
        echo "=== LLM Proxy Logs ==="
        kubectl logs -n konveyor-tackle deployment/llm-proxy --tail=50 || true
        echo ""
        echo "=== Llemulator Logs ==="
        kubectl logs -n konveyor-tackle deployment/llemulator --tail=50 || true
